{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

	<div class="container-fluid py-4">
		<div class="row mb-3">
			<div class="col-lg-12">
				<h2 class="text-gradient text-primary">Hi, {{ current_user.username }}</2>
			</div>
			<div class="col-lg-12 mb-lg-0 mb-4">
				<div class="card">
					<div class="card-body p-3">
						<div class="row">
							<div class="col-lg-6">
								<div class="d-flex flex-column h-100">
									<p class="mb-1 pt-2 text-bold">Built by developers</p>

									<h5 class="font-weight-bolder">Celery Dashboard</h5>
									<p class="mb-5">Awesome tools for manage your celery task for scrapping mode.</p>

									<a class="text-body text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
										Documentation <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
									</a>
								</div>
							</div>
							<div class="col-lg-5 ms-auto text-center mt-5 mt-lg-0">
								<div class="bg-gradient-primary border-radius-lg h-100">
									<img src="/static/assets-v2/img/shapes/waves-white.svg" class="position-absolute h-100 w-50 top-0 d-lg-block d-none" alt="waves">
									<div class="position-relative d-flex align-items-center justify-content-center h-100">
										<img class="w-50 position-relative z-index-2 pt-4" src="/static/assets-v2/img/illustrations/rocket-white.png" alt="rocket">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row mt-5">
			<div class="col-lg-12">
				<div class="row mb-3">
					<div class="col-lg-12">
						<h2 class="text-gradient text-primary">Sources : Running Task</2>
					</div>
					
					{% for i in capps.data %}
					<div class="col-lg-4 mb-3">
						<div class="card">
							<div class="card-body p-3">
								<div class="row">
									<div class="col-8">
										<div class="numbers">
											<p class="text-sm mb-0 text-capitalize font-weight-bold">{{ i }}</p>
											<h5 class="font-weight-bolder mb-0" id="{{ i }}-count">0</h5>
										</div>
									</div>
									<div class="col-4 text-end" id="{{ i }}-counter-color">
										<div class="icon icon-shape bg-gradient-secondary shadow text-center border-radius-md">
											<i class="ni ni-world-2 text-lg opacity-10" aria-hidden="true"></i>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					{% endfor %}

				</div>

				<div class="row mb-3">
					
					<div class="col-md-8">

						<div class="row mb-3">
							<div class="col-lg-12">
								<h2 class="text-gradient text-primary">Logs </h2>
							</div>
							<div class="col-lg-12">
								<div class="card z-index-2">
									<div class="card-body p-3">
										<label for="" class="text-primary">App Source  &nbsp; &nbsp; <div id="loader" style="float: right;" class="loader"></div></label>
										<select id="select_app" class="form-control form-control-lg"></select>
		
										<hr class="bg-gradient-dark"> 
		
										<!-- <div class="bg-gradient-dark border-radius-lg py-3 pe-1 mb-3">
											<div class="chart">
												<canvas id="chart-bars" class="chart-canvas" height="400"></canvas>
											</div>
										</div> -->

										<!-- <div class="position-relative border-radius-xl overflow-hidden shadow-lg "> -->
											<div class="container border-bottom">
												<div class="row justify-space-between py-2">
													<div class="col-lg-3 me-auto">
														<p class="lead text-dark pt-1 mb-0">Scraper Data</p>
													</div>
													<div class="col-lg-3">
														<div class="nav-wrapper position-relative end-0">
															<ul class="nav nav-pills nav-fill flex-row p-1" role="tablist">
																<li class="nav-item">
																	<a class="nav-link mb-0 px-0 py-1 active" data-bs-toggle="tab" href="#grafik" role="tab" aria-selected="true">
																		Graph
																	</a>
																</li>
																<li class="nav-item">
																	<a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#table" role="tab" aria-selected="false">
																		Table
																	</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
											<div class="tab-content tab-space">
												<div class="tab-pane active" id="grafik">
													<div class="position-relative p-4 pb-2">
														<div class="bg-gradient-dark border-radius-lg py-3 pe-1 mb-3">
															<div class="chart">
																<canvas id="chart-bars" class="chart-canvas" height="400"></canvas>
															</div>
														</div>
													</div>
												</div>
												<div class="tab-pane" id="table">
													<div class="position-relative p-4 pb-2">
														<div class="table-responsive">
															<table class="table align-items-center mb-0">
															  	<thead>
																	<tr>
																		<th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">App Source</th>
																		<th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Created</th>
																		<th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Updated</th>
																		<th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Total Companies Data</th>
																	</tr>
																</thead>
																<tbody id="result_scrapper_table"></tbody>
															</table>
														</div>
													</div>
												</div>
											</div>
										<!-- </div> -->

										
										<!-- <hr class="bg-gradient-dark"> 
		
										<div class="container border-radius-lg">
											<div class="row">
												<div class="col-6 py-3 ps-0 text-center">
													<h4><div class="icon icon-shape icon-xxs shadow border-radius-sm bg-gradient-primary "></div><span class="nav-link-text ms-1">Added</span></h4>
													<h4 class="font-weight-bolder">258</h4>
												</div>
												<div class="col-6 py-3 ps-0 text-center">
													<h4><div class="icon icon-shape icon-xxs shadow border-radius-sm bg-gradient-info "></div><span class="nav-link-text ms-1">Updated</span></h4>
													<h4 class="font-weight-bolder">115</h4>
												</div>
											</div>
										</div> -->
									</div>
								</div>
							</div>
						</div>

					</div>
					<div class="col-md-4">
						<div class="row mb-3">
							<div class="col-lg-12">
								<h2 class="text-gradient text-primary">Failure Tasks</2>
							</div>
							<div class="col-lg-12">
								<div class="card">
									
									<div class="card-body px-0 pb-2">
										<div class="table-responsive p-4">
											<table class="table align-items-center justify-content-center mb-0">
												<thead>
													<tr>
														<th colspan="2" class="text-uppercase text-dark text-xs font-weight-bolder opacity-7 ps-2">Task</th>
													</tr>
												</thead>
												<tbody id="result"></tbody>
												<tfoot>
													<tr>
														<td colspan="2" align="center">
															<hr class="bg-gradient-dark"> 
		
															<a href="/tasks.html" class="btn btn-outline-primary btn-sm mb-0 me-3">see more</a>
														</td>
													</tr>
												</tfoot>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>
		
		{% include "includes/footer.html" %}
	
	</div>


{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}
	<script src="/static/assets-v2/js/plugins/chartjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
	<script>
		var win = navigator.platform.indexOf('Win') > -1;
		if (win && document.querySelector('#sidenav-scrollbar')) {
			var options = {
				damping: '0.5'
			}
			Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
		}
	</script>

	<script>
		let base_url = window.location.origin;
		let app_name = localStorage.getItem("app_name") ? localStorage.getItem("app_name") : "indonesia";

		function getBg(count) {
			
			if (count > 0)
				return "bg-gradient-primary";

			return "bg-gradient-secondary";
		}

		function graph(labels, created_data, updated_data) {
			
			var ctx5 = document.getElementById("chart-bars").getContext("2d");

			Chart.defaults.set('plugins.datalabels', {
				color: '#FFF',
				anchor: 'end'
			});

			new Chart(ctx5, {
				type: "bar",
				data: {
					labels: labels,
					datasets: [
						{
							label: "Created",
							backgroundColor: '#cb0c9f',
							data: created_data,
							borderRadius: 4,
							barThickness: 25,
						},

						{
							label: "Updated",
							backgroundColor: '#2152ff',
							data: updated_data,
							borderRadius: 4,
							barThickness: 25,
						},
					],
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {
							display: true,
							position: 'bottom',
							labels: {
								padding: 40,
								color: '#FFF'
							}
						},
						
					},
					scales: {
						y: {
							grid: {
								drawBorder: false,
								display: true,
								drawOnChartArea: true,
								drawTicks: false,
								borderDash: [5, 5],
								color: '#8a869e'
							},
							ticks: {
								display: true,
								padding: 10,
								color: '#fff'
							}
						},
						x: {
							grid: {
								drawBorder: false,
								display: false,
								drawOnChartArea: true,
								drawTicks: true,
							},
							ticks: {
								display: true,
								color: '#fff',
								padding: 10
							}
						},
					},
				},
				plugins: [ChartDataLabels],

			});
		}

		function get_app() {
			$('#loader').show();
			$.get( base_url + "/v1/capps", function( data ) {
				var select_el = document.getElementById('select_app');
				var inner = ``;

				for (var i=0; i<data.data.length; i++) {
					if (app_name == data.data[i]) inner += `<option value="`+ data.data[i] +`" selected="true">` + data.data[i] + `</option>`
					else inner += `<option value="`+ data.data[i] +`">` + data.data[i] + `</option>`
				}
				
				select_el.innerHTML = inner;
			})
		}

		function update_select_app(app_name_) {
			localStorage.setItem("app_name", app_name_);
			app_name = app_name_;
			loadMore();
		}

		function loadMore() {
			$('#loader').show();
			$.get(base_url + "/v1/ctask/"+app_name, function( data ) {
				let el = document.getElementById("result");
				el.innerHTML = '';
				let keys = Object.keys(data.data);

				for (let i = 0; i < keys.length; i++) {
					if (keys[i] === "null")
						continue

					if (data.data[keys[i]].latest_status === 'FAILURE') {
						el.innerHTML = el.innerHTML + `
						<tr onMouseOver="this.style.background='#e3e8f0'" onMouseOut="this.style.background='#fff'">
							
							<td scope="row" style="cursor: pointer;" onClick="(
								function(){
								window.location.href = '/task-history.html?task_name=`+ data.data[keys[i]]['function_name'] + `'
								})();">
								<div class="media align-items-center">
									<div class="media-body">
										<span class="name mb-0 text-sm text-primary"><b>`+ keys[i] + `</b></span><br>
										<span class="text-xs">`+ new Date(data.data[keys[i]].latest_started * 1000)+`</span>
									</div>
								</div>
							</td>
							
						</tr>
						`;
					}
					
				}

				$('#loader').hide();
			});
		}

		$("#select_app").on('change', function() {
			update_select_app(this.value)
		});

		function get_number(country, divID, divIDIcon){
			$.get(base_url + "/v1/ctask/"+country, function( data ) {
				let el = document.getElementById("result");
				let keys = Object.keys(data.data);

				document.getElementById(divID).innerHTML = keys.length;
				// set icon
				document.getElementById(divIDIcon).innerHTML = `
					<div class="icon icon-shape `+ getBg(keys.length) +` shadow text-center border-radius-md">
						<i class="ni ni-world-2 text-lg opacity-10" aria-hidden="true"></i>
					</div>
				`;
			});
		}

		function load_sources_number() {
			// load sources 
			$.get( base_url + "/v1/capps", function( data ) {
				for (var i=0; i<data.data.length; i++) {
					get_number(data.data[i], data.data[i]+'-count', data.data[i]+'-counter-color');
				}
			});
		}

		function setup_graph_label(data) {
			const element = [];
				
			// to get key
			Object.values(data.data).forEach((item, index) => {
				if (Array.isArray(item) && item.length > 0) {
					element.push(Object.keys(data.data)[index]);
				}
			});

			return element;
		}

		function setup_graph_data(index, data) {
			const element = [];
				
			// to get key
			Object.values(data.data).forEach(item => {
				if (Array.isArray(item) && item.length > 0) {
					element.push(item[index]);
				}
			});

			return element;
		}

		function setup_table_data(data) {
			let el = document.getElementById("result_scrapper_table");
			el.innerHTML = '';


			Object.values(data.data).forEach((item, index) => {
				if (Array.isArray(item) && item.length > 0) {
					// console.log(Object.keys(data.data)[index] + ' - ' + item[1])
						
					el.innerHTML = el.innerHTML + `
					<tr>
						<td>
							<div class="d-flex px-2 py-1">
							<div>
								<div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
									<i class="ni ni-world-2 text-md opacity-10" aria-hidden="true"></i>
								</div>
							</div>
							<div class="d-flex flex-column justify-content-center">
								<h6 class="mb-0 text-xs">&nbsp; `+ Object.keys(data.data)[index] +`</h6>
								<p class="text-xs text-secondary mb-0">&nbsp; Scraper Result</p>
							</div>
							</div>
						</td>
						<td class="align-middle text-center">
							<span class="text-secondary text-xs font-weight-bold">`+ item[0] +`</span>
						</td>
						<td class="align-middle text-center">
							<span class="text-secondary text-xs font-weight-bold">`+ item[1] +`</span>
						</td>
						<td class="align-middle text-center">
							<span class="text-secondary text-xs font-weight-bold">`+ item[2] +`</span>
						</td>
					</tr>
					`;
				}
			});
		}

		function get_scraper_data() {

			
			$.get(base_url + "/v1/graph", function( data ) {
				// Graph
				var labels = setup_graph_label(data);
				var created_data = setup_graph_data(0, data);
				var updated_data = setup_graph_data(1, data);
				graph(labels, created_data, updated_data);


				// Table
				setup_table_data(data);
			})

		}

		$(function() {
			loadMore();
			get_app();
			load_sources_number();
			get_scraper_data();
		});
	</script>

	<script src="/static/assets-v2/js/soft-ui-dashboard.min.js?v=1.0.7"></script>

{% endblock javascripts %}
